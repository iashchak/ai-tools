<!DOCTYPE html>
<html>
    <head>
        <title>Apache Tomcat : ClusteringOverview</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Apache Tomcat</a></span>
                            </li>
                                                    <li>
                                <span><a href="Apache-Tomcat-Home_61320756.html">Apache Tomcat Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="FAQ_103098750.html">FAQ</a></span>
                            </li>
                                                    <li>
                                <span><a href="Clustering_103098820.html">Clustering</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Apache Tomcat : ClusteringOverview
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
    
        
    
        
        
            Created by <span class='author'> ASF Infrabot</span>, last modified by <span class='editor'> Konstantin Kolinko</span> on ноя 24, 2019
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><em>Permalink</em> to this page: <a href="https://cwiki.apache.org/confluence/x/DiklBg" rel="nofollow">https://cwiki.apache.org/confluence/x/DiklBg</a></p><h1 id="ClusteringOverview-FromZerotoClustered-anOverview">From Zero to Clustered - an Overview</h1><p>This overview document is based on a posting to the mailing list concerning clustering. This document gives a general overview of the issues and steps that are needed in order to set up a small cluster on a single Linux system. Further documents will add detail and expand on this overview.</p><h2 id="ClusteringOverview-GeneralThoughtsandtheMailingList">General Thoughts and the Mailing List</h2><p>At each stage of the setup, I recommend testing before moving on to the next section. The mailing list is a good source of helpful information for when you have problems, provided that you do the following.</p><ul><li>Ask simple, focused questions</li><li>Provide all of the requested information (inline, since the mailing list strips most attachments)</li><li>Try to format configuration files reasonably<ul><li>Remove comments</li><li>Be aware of word wrap</li><li>Don't use rich text / html text</li></ul></li></ul><p>Be aware that people on the mailing list are <strong>volunteers</strong>. Do not expect homework answers, complete web applications, or systems architecture from the list. Do expect to put in at least as much effort on solving the problem as the people helping you are.</p><p>Also, there is a lot of misleading, incomplete, and just flat wrong information concerning Tomcat floating around on the Internet. You might get accurate information elsewhere, but from what I've seen this is not very likely. The authoritative source for information is always:</p><p><a class="external-link" href="https://tomcat.apache.org/" rel="nofollow">https://tomcat.apache.org/</a></p><h2 id="ClusteringOverview-LinuxinGeneral">Linux in General</h2><p>You'll find that Linux is a different beast than Windows (even Windows 7). In particular file permissions, file ownerships, and SELinux present quite a different security model than the typical Windows installation. It's best to be aware of this from the start.</p><h2 id="ClusteringOverview-Purpose">Purpose</h2><p>The first question to answer is what is the purpose of this setup?</p><p>If you're running a test or production platform then set up a service account and install all Tomcats there. A service account is an unprivileged account used only for configuring and running Tomcat servers. Make this account inaccessible from the network, and give the account its own group.</p><p>If you're setting up a development platform, then just create a directory and unpack multiple Tomcat servers in that directory. This will make dealing with permissions easier, which is an important consideration when integrating Tomcat servers with IDEs such as Eclipse or NetBeans.</p><h2 id="ClusteringOverview-ApacheHTTPD">Apache HTTPD</h2><p>Rather than building your own Apache HTTPD, I recommend that you get and install the distribution package for Apache HTTPD. This will place files in line with the rest of your system, and it will also have a serviceable default configuration.</p><p>On Fedora, the Apache HTTPD packages include:</p><ul><li>apr</li><li>apr-util</li><li>apr-devel</li><li>apr-util-devel</li><li>httpd</li><li>httpd-devel</li><li>httpd-tools</li></ul><p>The -devel packages are very important, since you will be building mod_jk from source.</p><p>Most package managers will pull in the correct dependencies, however you will have to specify the development packages separately.</p><h2 id="ClusteringOverview-Java">Java</h2><p>There are several versions and several ways to install Java on a Linux platform. While both OpenJDK and Oracle's Java are reported to work well with Tomcat, some people have reported problems when using GJC. Make sure you have a reasonable version of Java installed, and that it's used by default.</p><p>Type:</p><div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>java -version
javac -version
</pre>
</div></div><p>to make sure you get the version you expect.</p><p>While the Tomcat startup scripts will do a good job at finding the desired Java, it's advantageous to set an environment variable to point to the desired JRE.</p><p>In a bash shell, just type the following:</p><div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>export JRE_HOME=[where your JRE is installed]
</pre>
</div></div><p>This will ensure that Tomcat uses the Java you want it to use. It's also a useful way to try new versions of Java.</p><h2 id="ClusteringOverview-Tomcat">Tomcat</h2><p>As I've noted above if you're setting up a pure development environment it's just best to create a directory in your home directory and unpack a Tomcat there. For now, just start with one.</p><p>If you have Java installed correctly, Tomcat comes ready to run out of the box. Just unpack it, cd to the bin directory, and run startup.sh. You should be able to browse to localhost:8080/ and see the Tomcat welcome page.</p><p>Now stop the Tomcat server with shutdown.sh and set up the manager application. This involves editing the tomcat-users.xml file found in the conf directory. Instructions for editing that file (for Tomcat 7) can be found here:</p><p><a class="external-link" href="https://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html#Configuring_Manager_Application_Access" rel="nofollow">https://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html#Configuring_Manager_Application_Access</a></p><p>Once it's running and you can access the manager application, then associate the installation with your IDE (if you're setting up a development environment). Now you can develop, debug, test, and deploy from within your IDE without running into permission issues.</p><div class="confluence-information-macro confluence-information-macro-warning"><span class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Unlike Apache HTTPD, most people on the mailing list do NOT recommend that you use the Linux distribution packaged versions of Tomcat. In general people have found that these are much more difficult to work with than just getting a stock Tomcat from <a class="external-link" href="https://tomcat.apache.org/" rel="nofollow">https://tomcat.apache.org/</a></p></div></div><h2 id="ClusteringOverview-mod_jkbuild">mod_jk build</h2><p>While other people have had difficulty (search the mailing list) building mod_jk on various platforms, I've never had much trouble. The steps are quite simple, provided you have the appropriate packages installed on your system.</p><ol><li><p>Download the source from <a class="external-link" href="https://tomcat.apache.org/download-connectors.cgi" rel="nofollow">https://tomcat.apache.org/download-connectors.cgi</a></p></li><li>Unpack it into a directory</li><li>cd to <code>[tomcat-connectors-1.xx]/native</code></li><li><p>Read <code>BUILDING.txt</code></p></li></ol><p>Following <code>BUILDING.txt</code>:</p><ol><li><code>./configure --with-apxs=/usr/sbin/apxs</code></li><li><code>make</code></li><li>su to root</li><li>cd back to where you were</li><li><code>make install</code></li></ol><p>This will put everything in the right place.</p><h2 id="ClusteringOverview-mod_jkconfiguration">mod_jk configuration</h2><p>Recent versions of mod_jk come with some very nice and well-commented examples. They can be found in <code>[tomcat-connectors-1.xx]/conf</code>. Read them, follow them, use them.</p><p>The defaults have been chosen to work in most general use cases.</p><p>In order to test mod_jk, map all of the examples (not just the *.jsp files).</p><p>Restart Apache HTTPD, and then start Apache Tomcat. You should be able to browse to localhost/examples and get the Apache Tomcat examples.</p><div class="confluence-information-macro confluence-information-macro-warning"><span class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Do <strong>NOT</strong> proceed with clustering until you successfully connect one Apache HTTPD with one Tomcat, and execute the examples.</p></div></div><p>Note that if you place all of your mappings in a uriworkermap.properties file, Apache HTTPD will reread this once per minute (by default). This is nice if you tend to add and delete Tomcat applications. It's probably not quite as nice for a production system (but I don't know what the overhead is).</p><h2 id="ClusteringOverview-Clustering">Clustering</h2><p>There are a lot of pieces to put together in order to get clustering to work. As noted in the introduction, this Wiki article just gives the lay of the land. Future articles will go into more detail.</p><h3 id="ClusteringOverview-Linux">Linux</h3><p>You have to ensure that multicast is enabled, and that multicast routing is set up. If you run iptables, you may run into firewall issues, but on the same system probably not.</p><h3 id="ClusteringOverview-mod_jk">mod_jk</h3><p>Each Tomcat gets at least one worker. This worker must be configured to talk to a particular Tomcat on the correct AJP/1.3 port.</p><p>There are some other constraints for load balancing workers that should be noted. In workers.properties:</p><ol><li>Each worker name in a cluster must be unique 2. The worker name must be the same as the jvmRoute attribute set in the Engine element of the target Tomcat 3. The worker name must be in a list of worker names for a loadbalancer</li></ol><p>The mapping in uriworkermap.properties should point to the new loadbalancer worker instead of an individual worker.</p><p>See the following for documentation on worker name versus jvmRoute attribute:</p><p><a class="external-link" href="https://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html#Cluster_Basics" rel="nofollow">https://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html#Cluster_Basics</a></p><p>See the following for mod_jk loadbalancer configuration:</p><p><a class="external-link" href="https://tomcat.apache.org/connectors-doc/reference/workers.html" rel="nofollow">https://tomcat.apache.org/connectors-doc/reference/workers.html</a></p><h3 id="ClusteringOverview-AnotherTomcat">Another Tomcat</h3><p>While the easiest way to get started with clustering is just to unpack another copy of Tomcat in another directory, it's probably far more useful to use the concept of CATALINA_HOME and CATALINA_BASE. See RUNNING.txt in the Tomcat directory for details.</p><p>However another Tomcat is installed, the following needs to be done.</p><ol><li>Change the SHUTDOWN port to not conflict with the first Tomcat</li><li>Change the HTTP/1.1 port to not conflict with the first Tomcat (useful for testing)</li><li>Change the AJP/1.3 port to match that configured in workers.properties</li><li>Change the jvmRoute attribute of the Engine element to match the correct worker name</li><li>Configure the manager application (useful for testing)</li></ol><h3 id="ClusteringOverview-Tomcatclusteringconfiguration">Tomcat clustering configuration</h3><p>The basic clustering documentation can be found here:</p><p><a class="external-link" href="https://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html" rel="nofollow">https://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html</a></p><p>It's long, involved, and needs to be read carefully. However, as a first pass the following will work.</p><ol><li>Make sure that each Tomcat has a unique jvmRoute in the Engine element (see above)</li><li>Make sure that the jvmRoute matches the correct worker name (see above)</li><li>Make sure that each Tomcat has a unique shutdown port (see above)</li><li>Make sure that each Tomcat has a unique AJP/1.3 port (see above)</li><li>Make sure that each AJP/1.3 port matches the correctly named worker in workers.properties (see above)</li><li>Make sure that each HTTP/1.1 port is unique (nice for manager access)</li><li>Copy the example configuration from <a class="external-link" href="https://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html" rel="nofollow">https://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html</a> to inside the Host element in each server.xml, but omit (for now) the Deployer element. The cluster configuration can be placed inside the Host or Engine element. However, the Farm Deployer element will only work if the cluster configuration is inside the Host element.</li><li>Start up your Tomcat servers. If everything is set up correctly, cluster notifications will appear in the logs.</li></ol><p>It's also useful to have the access log enabled for your Tomcat servers. You can then tell which Tomcat is receiving the request from Apache HTTPD.</p><hr/><p>This overview should point you in the right direction to get a two node cluster up and running.</p><p>Again, start simply.</p><ol><li>Stock Apache HTTPD installation (and verify)</li><li>Stock Apache Tomcat installation (and verify)</li><li>mod_jk installation (and verify)</li><li>Second Apache Tomcat installation (and verify)</li><li>Cluster  </li></ol>
                    </div>

                                        
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on мая 02, 2023 11:01</p>
                    <div id="footer-logo"><a href="https://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
