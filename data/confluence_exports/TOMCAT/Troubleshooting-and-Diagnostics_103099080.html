<!DOCTYPE html>
<html>
    <head>
        <title>Apache Tomcat : Troubleshooting and Diagnostics</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Apache Tomcat</a></span>
                            </li>
                                                    <li>
                                <span><a href="Apache-Tomcat-Home_61320756.html">Apache Tomcat Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="FAQ_103098750.html">FAQ</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Apache Tomcat : Troubleshooting and Diagnostics
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
    
        
    
        
        
            Created by <span class='author'> ASF Infrabot</span>, last modified by <span class='editor'> Konstantin Kolinko</span> on авг 05, 2022
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><em>Permalink</em> to this page: <a href="https://cwiki.apache.org/confluence/x/yColBg" rel="nofollow">https://cwiki.apache.org/confluence/x/yColBg</a></p><p>Troubleshooting and Diagnostics techniques.</p><h2 id="TroubleshootingandDiagnostics-TableofContents">Table of Contents</h2><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1683025319757 {padding: 0px;}
div.rbtoc1683025319757 ul {margin-left: 0px;}
div.rbtoc1683025319757 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1683025319757'>
<ul class='toc-indentation'>
<li><a href='#TroubleshootingandDiagnostics-Techniques&amp;Reference'>Techniques &amp; Reference</a></li>
<li><a href='#TroubleshootingandDiagnostics-Tools'>Tools</a>
<ul class='toc-indentation'>
<li><a href='#TroubleshootingandDiagnostics-JMXClients'>JMX Clients</a></li>
<li><a href='#TroubleshootingandDiagnostics-JDKtools'>JDK tools</a></li>
<li><a href='#TroubleshootingandDiagnostics-Profilers&amp;HeapAnalyzers'>Profilers &amp; Heap Analyzers</a></li>
</ul>
</li>
<li><a href='#TroubleshootingandDiagnostics-NotesonusingJMXclients'>Notes on using JMX clients</a></li>
<li><a href='#TroubleshootingandDiagnostics-CommonTroubleshootingScenario'>Common Troubleshooting Scenario</a></li>
<li><a href='#TroubleshootingandDiagnostics-TroubleshootingunexpectedResponsestateproblems'>Troubleshooting unexpected Response state problems</a></li>
<li><a href='#TroubleshootingandDiagnostics-Troubleshooting&quot;Toomanyopenfiledescriptors&quot;'>Troubleshooting &quot;Too many open file descriptors&quot;</a></li>
</ul>
</div></p><h2 id="TroubleshootingandDiagnostics-Techniques&amp;Reference">Techniques &amp; Reference</h2><ul><li><a href="HowTo_103099265.html#HowTo-How_do_I_obtain_a_thread_dump_of_my_running_webapp_.3F">How To: Capture a thread dump</a></li><li><a href="HowTo_103099265.html#HowTo-How_do_I_obtain_a_heap_dump.3F">How To: Capture a heap dump</a></li><li><a href="HowTo_103099265.html#HowTo-How_do_I_read_a_stack_trace.3F">How To: Examine a Stacktrace</a></li><li><a href="HowTo_103099265.html#HowTo-How_do_I_debug_a_Tomcat_application.3F">How To: Configure Tomcat for debugging</a></li><li><a href="Developing_103098864.html">FAQ: Developing</a></li><li><a href="Memory_103098949.html">FAQ: Memory</a></li><li><a href="MemoryLeakProtection_103099526.html">Tomcat Memory Leak Protection</a></li><li><a href="#TroubleshootingandDiagnostics-usingjmxclients">Notes on using JMX clients</a></li></ul><h2 id="TroubleshootingandDiagnostics-Tools">Tools</h2><h3 id="TroubleshootingandDiagnostics-JMXClients">JMX Clients</h3><ul><li>JJConsole: <a class="external-link" href="https://download.oracle.com/javase/6/docs/technotes/tools/share/jconsole.html" rel="nofollow">Documentation</a></li><li>VisualVM: <a class="external-link" href="https://docs.oracle.com/javase/6/docs/technotes/tools/share/jvisualvm.html" rel="nofollow">Documentation</a>, <a class="external-link" href="http://visualvm.dev.java.net" rel="nofollow">Project</a></li></ul><h3 id="TroubleshootingandDiagnostics-JDKtools">JDK tools</h3><ul><li><a class="external-link" href="https://download.oracle.com/javase/6/docs/technotes/tools/share/jinfo.html" rel="nofollow">jinfo - Prints JVM process info</a></li><li><a class="external-link" href="https://download.oracle.com/javase/6/docs/technotes/tools/share/jstack.html" rel="nofollow">jstack - Prints thread stack traces</a></li><li><a class="external-link" href="https://download.oracle.com/javase/6/docs/technotes/tools/share/jmap.html" rel="nofollow">jmap - Dumps heap and shows heap status</a></li><li><a class="external-link" href="https://download.oracle.com/javase/6/docs/technotes/tools/share/jhat.html" rel="nofollow">jhat - Heap Analyzer Tool</a></li><li><a class="external-link" href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/jcmd.html" rel="nofollow">jcmd - Multitool intended to replace the above JDK tools</a></li></ul><h3 id="TroubleshootingandDiagnostics-Profilers&amp;HeapAnalyzers">Profilers &amp; Heap Analyzers</h3><ul><li><a class="external-link" href="https://www.eclipse.org/mat/" rel="nofollow">Eclipse Memory Analyzer (MAT)</a></li><li><a class="external-link" href="https://www.yourkit.com/" rel="nofollow">YourKit Profiler</a></li><li><p class="auto-cursor-target"><a class="external-link" href="https://docs.oracle.com/javase/6/docs/technotes/tools/share/jvisualvm.html" rel="nofollow">VisualVM Docs</a></p></li></ul><p><span class="confluence-anchor-link" id="TroubleshootingandDiagnostics-usingjmxclients"></span></p><h2 id="TroubleshootingandDiagnostics-NotesonusingJMXclients">Notes on using JMX clients</h2><p>When running a JMX client (JConsole, VisualVM) on the same machine as the target JVM process it is possible to connect without pre-configuring a JMX port, using the local connector stub. This method relies on being able to create a protected temporary file, accessible only to a user with administrator privileges. Java processes which are accessible via the local connector will automatically appear in the client.</p><p>NB(1) On Windows, this means that the temporary directory must be located on an NTFS formatted disk. See the following link for more details.</p><p>NB(2) On Windows, if Tomcat is started using a service wrapper, this will prevent JConsole &amp; VisualVM from using the local JMX connector stub.</p><p><a class="external-link" href="https://docs.oracle.com/javase/1.5.0/docs/guide/management/faq.html" rel="nofollow">Java 5 JConsole and Remote Management FAQ</a></p><p>From Java 6 onward a process does not need to have the management agent enabled when it starts, as the Attach API permits the management agent to be activated on demand.</p><h2 id="TroubleshootingandDiagnostics-CommonTroubleshootingScenario">Common Troubleshooting Scenario</h2><p>If you <em>have already looked into Tomcat logs</em>, there are no error messages, and you just want to find out what is going on, you may try the following</p><ol><li>Look into <a href="HowTo_103099265.html#HowTo-HowdoIlogrequests?">Tomcat access log</a> (the log file generated by <a href="AccessLogValve_103098448.html">AccessLogValve</a>). <br class="atl-forced-newline"/><ol><li>If your request is not listed there, then it has not been processed by Tomcat. You need to look elsewhere (e.g. at your firewall).</li><li>You will see what IP address your client is using, and whether it is using an IPv4 (<code>127.0.0.1</code>) or IPv6 address (<code>0:0:0:0:0:0:0:1</code>).<br/>Modern operating systems can use IPv6 addresses for localhost / local network access, while external network is still using IPv4.</li></ol></li><li><a href="HowTo_103099265.html#HowTo-HowdoIobtainathreaddumpofmyrunningwebapp?">Take a thread dump</a>. This way you will find out what Tomcat is actually doing.<ol><li>If you are troubleshooting some process that takes noticeable time, take <strong>several</strong> (three) thread dumps with some interval between them. This way you will see if there are any changes, any progress.</li></ol></li><li>Try <a href="Developing_103098864.html#Developing-Debugging">debugging</a>.<ol><li>A good place for a breakpoint is <code>org.apache.catalina.connector.CoyoteAdapter.service()</code> method. That is the entry point from Tomcat connectors and into the Servlet engine. At that place your request has already been received and its processing starts.</li></ol></li><li>If you did a long-awaited upgrade, jumping over several years worth of Tomcat releases, and something broke, and you have no clue,<ol><li>Reading <a class="external-link" href="https://tomcat.apache.org/migration.html" rel="nofollow">Migration guides</a> may help.</li><li>It may help to do a <a class="external-link" href="https://en.wikipedia.org/wiki/Binary_search_algorithm" rel="nofollow">binary search</a> (aka <a class="external-link" href="https://en.wikipedia.org/wiki/Bisection_(software_engineering)" rel="nofollow">bisecting</a>) to locate the version of Tomcat that triggered the change. If your issue is easy to reproduce, it may be pretty fast. Just 7-8 tries may cover a range of 100 versions. Once you know the version and its release date, the following resources are available:<ol><li>The release announcement.<br/>See &quot;<a class="external-link" href="https://tomcat.apache.org/oldnews.html" rel="nofollow">former announcements</a>&quot; link at the bottom of the front page of the <a class="external-link" href="https://tomcat.apache.org/" rel="nofollow">Apache Tomcat site</a>. <br/>An announcement mail message can also be found in the archives of the &quot;announce@&quot; <a class="external-link" href="https://tomcat.apache.org/lists.html#tomcat-announce" rel="nofollow">mailing list</a>.</li><li>The changelog. A release announcement usually has a link to it.</li><li>Archives of the &quot;users@&quot; <a class="external-link" href="https://tomcat.apache.org/lists.html#tomcat-users" rel="nofollow">mailing list</a>. You may look for discussions that happened a month or two after the release.</li></ol></li></ol></li></ol><h2 id="TroubleshootingandDiagnostics-TroubleshootingunexpectedResponsestateproblems">Troubleshooting unexpected Response state problems</h2><p>If you encounter problems that manifest themselves as accessing a request or response that is an inconsistent state, the main suspect is <strong>your own web application</strong> (or a library that it uses) keeping a reference to Request or Response objects outside of their life cycle. Examples: <a class="external-link" href="https://bz.apache.org/bugzilla/show_bug.cgi?id=61289" rel="nofollow">BZ 61289</a>, <a class="external-link" href="https://bz.apache.org/bugzilla/show_bug.cgi?id=58457" rel="nofollow">BZ 58457</a>.</p><p>The lifetime of the Response object is documented in the<span> </span><a href="Specifications_103100166.html">Servlet specification</a>. Quoting from section &quot;5.8 Lifetime of the Response Object&quot; of Servlet 4.0 specification:</p><p style="margin-left: 30.0px;">&quot;Each response object is valid only within the scope of a servlet’s service method, or within the scope of a filter’s doFilter method, unless the associated request object has asynchronous processing enabled for the component. If asynchronous processing on the associated request is started, then the response object remains valid until complete method on AsyncContext is called.&quot;</p><p>In case of asynchronous processing, when an error occurs Tomcat notifies all registered<span> </span><code>AsyncListener</code>s and then calls <code>complete()</code> automatically if none of the listeners have called it yet. (Reference:<span> </span><a class="external-link" href="https://bz.apache.org/bugzilla/show_bug.cgi?id=61768#c3" rel="nofollow" style="text-decoration: none;">61768</a>)</p><p>Also see sections &quot;2.3.3.4 Thread Safety&quot; and &quot;3.13 Lifetime of the Request Object&quot; of the same specification.</p><p>To troubleshoot the issue:</p><ol><li>Make sure that your Tomcat is configured to discard facades to its internal objects when request processing completes. This makes it easier to spot illegal access when it happens, instead of waiting until side effects of such access become visible. Essentially, it protects Tomcat internals from misbehaving web applications.<br/><br/>This feature is always on when you are running Tomcat with a <a class="external-link" href="https://tomcat.apache.org/tomcat-9.0-doc/security-manager-howto.html" rel="nofollow">Java Security Manager being enabled</a>. Starting with Tomcat 10.0 this feature is enabled by default. It is <strong>disabled</strong> by default in earlier versions of Tomcat. The way this feature is configured differs between versions: it is controlled by an attribute on <a class="external-link" href="https://tomcat.apache.org/tomcat-10.0-doc/config/http.html" rel="nofollow">Connector</a> element or by a <a class="external-link" href="https://tomcat.apache.org/tomcat-9.0-doc/config/systemprops.html#Security" rel="nofollow">system property</a>.<br/><br/>If you are running Tomcat 9.0 or earlier, do both of the following:<br/><br/>- Set the following <a class="external-link" href="https://tomcat.apache.org/tomcat-9.0-doc/config/systemprops.html#Security" rel="nofollow">system property</a> in Tomcat configuration: <br class="atl-forced-newline"/><code>org.apache.catalina.connector.RECYCLE_FACADES=true</code><br/><br/>- Add the following attribute to all <a class="external-link" href="https://tomcat.apache.org/tomcat-9.0-doc/config/http.html" rel="nofollow">Connector</a> elements:<br/><code class="attributeName">discardFacades</code>=&quot;true&quot;<br class="atl-forced-newline"/><br/>The Connector attribute was added in Tomcat 10.0.0-M1, 9.0.31, 8.5.51 and 7.0.100. The system property is an older way to configure this feature. In case of a doubt, or if you are switching back and forth between versions while troubleshooting the issue, it is safer to configure both of them.<br/><br/>This feature is also mentioned on the <a class="external-link" href="https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#System_Properties" rel="nofollow">Security Considerations</a> page in Tomcat documentation. You can also search the archives of the Tomcat users' <a class="external-link" href="https://tomcat.apache.org/lists.html" rel="nofollow">mailing lists</a> for previous discussions mentioning the RECYCLE_FACADES flag.</li></ol><p>Accessing response objects after their lifetime can lead to security issues in your application, such as sending responses to wrong clients, mixing up responses. If you can reproduce the issue and the above diagnostic does not show your own bug, but a bug in Apache Tomcat, if the problem manifests as a security issue, see <a class="external-link" href="https://tomcat.apache.org/security.html" rel="nofollow">how to report it</a>.</p><p>There are some known examples of broken libraries / APIs:</p><ol><li>Read about <a href="KnownIssues_103098892.html#KnownIssues-ImageIOIssues">Java ImageIO</a> issue — an issue with <a class="external-link" href="https://doc.bccnsoft.com/docs/jdk11-docs/api/java.desktop/javax/imageio/ImageIO.html" rel="nofollow">javax.imageio.ImageIO</a> API. It may have already been fixed as it is an old issue, but there are no clear records of it.</li><li>Read about an <a href="KnownIssues_103098892.html#KnownIssues-PD4ML">issue in PD4ML,</a> a library that is used to generate PDF files, — fixed in their version 3.8.0, earlier versions may be affected.</li></ol><h2 id="TroubleshootingandDiagnostics-Troubleshooting&quot;Toomanyopenfiledescriptors&quot;">Troubleshooting &quot;Too many open file descriptors&quot;</h2><p>The code that opens the descriptors can be identified using a tool such as <a class="external-link" href="http://file-leak-detector.kohsuke.org/" rel="nofollow">http://file-leak-detector.kohsuke.org/</a></p>
                    </div>

                                        
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on мая 02, 2023 11:01</p>
                    <div id="footer-logo"><a href="https://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
